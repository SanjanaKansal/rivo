{% extends 'dashboard/base.html' %}

{% block title %}Dashboard - Rivo{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Clients</h1>
</div>

<div class="card">
    <div style="margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
        <input type="text" id="searchFilter" class="form-input" placeholder="Search by name, email, phone..." style="max-width: 300px;" onkeyup="filterClients()">
        <select id="stageFilter" class="form-select" style="max-width: 200px;" onchange="filterClients()">
            <option value="">All Stages</option>
            {% for stage_key, stage_name in stage_choices %}
            <option value="{{ stage_key }}">{{ stage_name }}</option>
            {% endfor %}
        </select>
    </div>
    
    {% if clients %}
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Stage</th>
                {% if perms.can_assign %}
                <th>Assigned To</th>
                {% endif %}
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for client in clients %}
            <tr data-stage="{{ client.current_stage }}">
                <td><strong>{{ client.name|default:"-" }}</strong></td>
                <td>{{ client.email|default:"-" }}</td>
                <td>{{ client.phone|default:"-" }}</td>
                <td><span class="badge badge-{{ client.current_stage }}">{{ client.get_current_stage_display }}</span></td>
                {% if perms.can_assign %}
                <td>
                    {% if client.active_csm %}
                        {{ client.active_csm.get_full_name|default:client.active_csm.email }}
                    {% else %}
                        <form method="post" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="client_id" value="{{ client.id }}">
                            <select name="csm_id" class="form-select" style="width: auto; display: inline-block; padding: 0.3rem;" required>
                                <option value="">Assign to...</option>
                                {% for csm in csm_users %}
                                <option value="{{ csm.id }}">{{ csm.get_full_name|default:csm.email }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-primary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">Assign</button>
                        </form>
                    {% endif %}
                </td>
                {% endif %}
                <td>
                    <a href="{% url 'dashboard:client_detail' client.id %}" class="btn btn-primary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">View</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #7f8c8d; text-align: center; padding: 2rem;">No clients found.</p>
    {% endif %}
</div>

<script>
function filterClients() {
    const search = document.getElementById('searchFilter').value.toLowerCase();
    const stage = document.getElementById('stageFilter').value;
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const rowStage = row.dataset.stage;
        const matchesStage = !stage || rowStage === stage;
        const matchesSearch = text.includes(search);
        row.style.display = (matchesSearch && matchesStage) ? '' : 'none';
    });
}
</script>
{% endblock %}

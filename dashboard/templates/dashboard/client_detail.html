{% extends 'dashboard/base.html' %}

{% block title %}{{ client.name }} - Rivo{% endblock %}

{% block content %}
<style>
    .back-link { color: #3498db; text-decoration: none; font-size: 0.75rem; }
    .client-header { display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; }
    .client-info h1 { font-size: 1rem; margin: 0; color: #2c3e50; }
    .client-info span { color: #7f8c8d; font-size: 0.75rem; }
    .stage-form { display: flex; gap: 0.3rem; }
    
    .summary-box { background: #f0f7ff; border-left: 3px solid #3498db; padding: 0.5rem 0.75rem; margin-bottom: 0.5rem; font-size: 0.85rem; }
    
    .context-row { display: flex; flex-wrap: wrap; gap: 0.75rem; font-size: 0.8rem; }
    .context-item { display: flex; gap: 0.3rem; }
    .context-label { color: #7f8c8d; }
    .context-value { color: #2c3e50; font-weight: 500; }
    
    .context-section { margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee; }
    
    .tag { background: #e8f4fd; color: #2980b9; padding: 0.1rem 0.4rem; border-radius: 8px; font-size: 0.7rem; margin-right: 0.25rem; }
    
    .history-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem 0; border-bottom: 1px solid #f0f0f0; font-size: 0.75rem; }
    .history-item:last-child { border: none; }
    
    .sentiment-positive { color: #27ae60; }
    .sentiment-neutral { color: #f39c12; }
    .sentiment-negative { color: #e74c3c; }
</style>

<a href="{% url 'dashboard:home' %}" class="back-link">&larr; Back</a>

<div class="card">
    <div class="client-header">
        <div class="client-info">
            <h1>{{ client.name|default:"Unnamed" }}</h1>
            <span>{{ client.email|default:"-" }} | {{ client.phone|default:"-" }}</span>
        </div>
        {% if perms.can_change_client %}
        <form method="post" class="stage-form">{% csrf_token %}{{ form.new_stage }}<button type="submit" class="btn btn-success">Save</button></form>
        {% else %}
        <span class="badge badge-{{ client.current_stage }}">{{ client.get_current_stage_display }}</span>
        {% endif %}
    </div>
</div>

{% if client.context %}
<div class="card">
    {% if client.context.summary %}
    <div class="summary-box">{{ client.context.summary }}</div>
    {% endif %}
    
    <div class="context-row">
        <div class="context-item"><span class="context-label">Intent:</span><span class="context-value">{{ client.context.intent|default:"-" }}</span></div>
        <div class="context-item"><span class="context-label">Sentiment:</span><span class="context-value sentiment-{{ client.context.sentiment|default:'neutral' }}">{{ client.context.sentiment|default:"-"|capfirst }}</span></div>
        <div class="context-item"><span class="context-label">Urgency:</span><span class="context-value">{{ client.context.urgency|default:"-"|capfirst }}</span></div>
    </div>
    
    {% if client.context.loan_details %}
    <div class="context-section context-row">
        {% with loan=client.context.loan_details %}
        {% if loan.loan_type %}<div class="context-item"><span class="context-label">Loan:</span><span class="context-value">{{ loan.loan_type }}</span></div>{% endif %}
        {% if loan.current_loan_amount %}<div class="context-item"><span class="context-label">Amount:</span><span class="context-value">{{ loan.current_loan_amount }}</span></div>{% endif %}
        {% if loan.interest_rate %}<div class="context-item"><span class="context-label">Rate:</span><span class="context-value">{{ loan.interest_rate }}</span></div>{% endif %}
        {% if loan.monthly_payment %}<div class="context-item"><span class="context-label">Payment:</span><span class="context-value">{{ loan.monthly_payment }}</span></div>{% endif %}
        {% endwith %}
    </div>
    {% endif %}
    
    {% if client.context.financial_info %}
    <div class="context-section context-row">
        {% with fin=client.context.financial_info %}
        {% if fin.income %}<div class="context-item"><span class="context-label">Income:</span><span class="context-value">{{ fin.income }}</span></div>{% endif %}
        {% if fin.credit_score %}<div class="context-item"><span class="context-label">Credit:</span><span class="context-value">{{ fin.credit_score }}</span></div>{% endif %}
        {% if fin.debt_to_income %}<div class="context-item"><span class="context-label">DTI:</span><span class="context-value">{{ fin.debt_to_income }}</span></div>{% endif %}
        {% endwith %}
    </div>
    {% endif %}
    
    {% if client.context.key_points %}
    <div class="context-section">{% for point in client.context.key_points %}<span class="tag">{{ point }}</span>{% endfor %}</div>
    {% endif %}
</div>
{% endif %}

{% if stage_history %}
<div class="card">
    {% for h in stage_history %}
    <div class="history-item">
        {% if h.from_stage %}<span class="badge badge-{{ h.from_stage }}">{{ h.from_stage }}</span>&rarr;{% endif %}
        <span class="badge badge-{{ h.to_stage }}">{{ h.to_stage }}</span>
        <span style="color:#999;">{{ h.created_at|date:"M d H:i" }}</span>
        {% if h.remarks %}<span style="color:#666;">- {{ h.remarks }}</span>{% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}
